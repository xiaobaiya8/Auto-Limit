{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> 系统状态
                </h5>
            </div>
            <div class="card-body">
                <!-- 播放状态概览 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div id="playback-status-indicator" class="status-indicator status-inactive me-2"></div>
                            <div>
                                <h6 class="mb-0">播放状态</h6>
                                <span id="playback-status-text" class="text-muted">加载中...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-server text-primary me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0">媒体服务器</h6>
                                <span class="text-muted">{{ settings.media_servers | selectattr('enabled') | list | length }} 个已启用</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-download text-success me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0">下载器</h6>
                                <span class="text-muted">{{ settings.downloaders | selectattr('enabled') | list | length }} 个已启用</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 当前播放详情 -->
                <div id="session-details" class="mb-4"></div>
                
                <hr>
                
                <!-- 实例状态 -->
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h6><i class="bi bi-server"></i> 媒体服务器实例</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_servers = settings.media_servers | selectattr('enabled') | list %}
                            {% if enabled_servers %}
                                {% for server in enabled_servers %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ server.id }}" data-instance-type="media_servers">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <img src="{{ url_for('static', filename='img/logos/' + server.type + '.png') }}" 
                                                     alt="{{ server.type }}" class="instance-logo"
                                                     onerror="this.style.display='none'">
                                                <span class="fw-bold">{{ server.name or '未命名' }}</span> 
                                                <span class="badge bg-secondary ms-2">{{ server.type | title }}</span>
                                            </div>
                                            <small class="text-muted d-block">{{ server.url or 'URL未配置' }}</small>
                                            <small class="text-info">轮询间隔: {{ server.poll_interval or 15 }}秒</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">
                                            <i class="bi bi-wifi"></i> 测试
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-server text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-1">没有已启用的媒体服务器</p>
                                    <a href="{{ url_for('main.config') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-gear"></i> 前往配置
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-download"></i> 下载器实例</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_downloaders = settings.downloaders | selectattr('enabled') | list %}
                            {% if enabled_downloaders %}
                                {% for downloader in enabled_downloaders %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ downloader.id }}" data-instance-type="downloaders">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <img src="{{ url_for('static', filename='img/logos/' + downloader.type + '.png') }}" 
                                                     alt="{{ downloader.type }}" class="instance-logo"
                                                     onerror="this.style.display='none'">
                                                <span class="fw-bold">{{ downloader.name or '未命名' }}</span> 
                                                <span class="badge bg-secondary ms-2">{{ downloader.type | title }}</span>
                                            </div>
                                            <small class="text-muted d-block">{{ downloader.url or 'URL未配置' }}</small>
                                            <div class="mt-1" id="downloader-{{ downloader.id }}-status">
                                                <small class="text-muted">加载状态中...</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">
                                            <i class="bi bi-wifi"></i> 测试
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-download text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-1">没有已启用的下载器</p>
                                    <a href="{{ url_for('main.config') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-gear"></i> 前往配置
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- 系统信息 -->
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-clock-history text-info" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">调度器状态</small>
                                <span id="scheduler-status" class="badge bg-success">运行中</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-speedometer2 text-warning" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">当前限速模式</small>
                                <span id="speed-mode" class="badge bg-secondary">检测中</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-arrow-repeat text-primary" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">最后更新</small>
                                <span id="last-update" class="small text-muted">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-journal-text text-secondary" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">快速操作</small>
                                <a href="{{ url_for('main.logs_page') }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-journal-text"></i> 查看日志
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="application/json" id="app-config">{{ settings | tojson | safe }}</script>
<script>
// 全局配置数据
window.APP_CONFIG = JSON.parse(document.getElementById('app-config').textContent);

function updateStatus() {
    // 获取播放状态
    fetch('/api/media_server/sessions')
        .then(response => response.json())
        .then(data => {
            const indicator = document.getElementById('playback-status-indicator');
            const statusText = document.getElementById('playback-status-text');
            const sessionDetails = document.getElementById('session-details');
            const speedMode = document.getElementById('speed-mode');
            const lastUpdate = document.getElementById('last-update');
            
            // 更新最后更新时间
            lastUpdate.textContent = new Date().toLocaleTimeString();
            
            if (data.status === 'success' && data.sessions.length > 0) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = `有 ${data.count} 个活跃播放`;
                speedMode.className = 'badge bg-warning';
                speedMode.textContent = '播放时限速';
                
                let detailsHtml = '<div class="alert alert-info py-2"><h6 class="mb-2"><i class="bi bi-play-circle"></i> 当前播放详情</h6><div class="row">';
                data.sessions.forEach((session, index) => {
                    detailsHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-primary me-2"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${session.user_name}</div>
                                    <small class="text-muted">${session.item_name}</small>
                                    <span class="badge bg-info ms-2">${session.source_server}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                detailsHtml += '</div></div>';
                sessionDetails.innerHTML = detailsHtml;

            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = '无播放活动';
                speedMode.className = 'badge bg-success';
                speedMode.textContent = '默认限速';
                sessionDetails.innerHTML = '';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            document.getElementById('playback-status-text').textContent = '状态获取失败';
            document.getElementById('scheduler-status').className = 'badge bg-danger';
            document.getElementById('scheduler-status').textContent = '连接失败';
        });

    // 获取下载器状态
    updateDownloadersStatus();
    
    // 检查调度器状态
    fetch('/health')
        .then(response => response.json())
        .then(data => {
            const schedulerStatus = document.getElementById('scheduler-status');
            if (data.status === 'healthy') {
                schedulerStatus.className = 'badge bg-success';
                schedulerStatus.textContent = '运行中';
            } else {
                schedulerStatus.className = 'badge bg-danger';
                schedulerStatus.textContent = '异常';
            }
        })
        .catch(error => {
            const schedulerStatus = document.getElementById('scheduler-status');
            schedulerStatus.className = 'badge bg-danger';
            schedulerStatus.textContent = '连接失败';
        });
}

function updateDownloadersStatus() {
    fetch('/api/downloaders/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                data.downloaders.forEach(downloader => {
                    const statusElement = document.getElementById(`downloader-${downloader.id}-status`);
                    if (statusElement) {
                        let statusHtml = '';
                        
                        // 显示当前激活的限速模式
                        const modeColor = downloader.speed_mode === 'playing' ? 'text-warning' : 'text-success';
                        const modeText = downloader.speed_mode === 'playing' ? '播放时限速' : '默认限速';
                        const activeLimits = downloader.active_limits;
                        
                        statusHtml += `<small class="${modeColor}">`;
                        statusHtml += `<i class="bi bi-speedometer2"></i> ${modeText}: `;
                        statusHtml += `${formatSpeed(activeLimits.download)} / ${formatSpeed(activeLimits.upload)}`;
                        statusHtml += `</small>`;
                        
                        // 显示实际速度（如果支持）
                        if (downloader.current_speeds && (downloader.type === 'qbittorrent' || downloader.type === 'transmission')) {
                            const currentSpeeds = downloader.current_speeds;
                            statusHtml += '<br>';
                            statusHtml += `<small class="text-info">`;
                            statusHtml += `<i class="bi bi-activity"></i> 实际速度: `;
                            statusHtml += `${formatActualSpeed(currentSpeeds.download_speed)} / ${formatActualSpeed(currentSpeeds.upload_speed)}`;
                            statusHtml += `</small>`;
                        } else if (downloader.type === 'qbittorrent' || downloader.type === 'transmission') {
                            // 支持获取速度但当前无法获取
                            statusHtml += '<br>';
                            statusHtml += `<small class="text-muted">`;
                            statusHtml += `<i class="bi bi-activity"></i> 实际速度: 获取中...`;
                            statusHtml += `</small>`;
                        } else if (downloader.type === 'clouddrive2') {
                            // CloudDrive2暂不支持实时速度获取
                            statusHtml += '<br>';
                            statusHtml += `<small class="text-muted">`;
                            statusHtml += `<i class="bi bi-info-circle"></i> 暂不支持实时速度显示`;
                            statusHtml += `</small>`;
                        }
                        
                        statusElement.innerHTML = statusHtml;
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error fetching downloaders status:', error);
            // 在错误情况下显示基本信息
            document.querySelectorAll('[id^="downloader-"][id$="-status"]').forEach(element => {
                element.innerHTML = '<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> 状态获取失败</small>';
            });
        });
}

function testInstance(button) {
    const btn = button;
    const itemElement = btn.closest('.list-group-item');
    const instanceId = itemElement.dataset.instanceId;
    const instanceType = itemElement.dataset.instanceType;
    
    // 从全局配置中查找实例的具体信息
    const instanceConfig = window.APP_CONFIG[instanceType].find(inst => inst.id === instanceId);

    if (!instanceConfig) {
        showToast('无法在配置中找到该实例', 'error', '配置错误');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch('/test_connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            instance_config: instanceConfig,
            instance_type: instanceType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`${instanceConfig.name || instanceConfig.type} 连接成功`, 'success', '连接测试');
        } else {
            showToast(`${instanceConfig.name || instanceConfig.type} 连接失败: ${data.message}`, 'error', '连接测试');
        }
    })
    .catch(error => {
        showToast(`${instanceConfig.name || instanceConfig.type} 连接测试时发生网络错误: ${error.message}`, 'error', '网络错误');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-wifi"></i> 测试';
    });
}

// 页面加载时立即更新状态
updateStatus();

// 播放状态每10秒更新一次（不需要太频繁）
setInterval(() => {
    // 获取播放状态
    fetch('/api/media_server/sessions')
        .then(response => response.json())
        .then(data => {
            const indicator = document.getElementById('playback-status-indicator');
            const statusText = document.getElementById('playback-status-text');
            const sessionDetails = document.getElementById('session-details');
            const speedMode = document.getElementById('speed-mode');
            const lastUpdate = document.getElementById('last-update');
            
            // 更新最后更新时间
            lastUpdate.textContent = new Date().toLocaleTimeString();
            
            if (data.status === 'success' && data.sessions.length > 0) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = `有 ${data.count} 个活跃播放`;
                speedMode.className = 'badge bg-warning';
                speedMode.textContent = '播放时限速';
                
                let detailsHtml = '<div class="alert alert-info py-2"><h6 class="mb-2"><i class="bi bi-play-circle"></i> 当前播放详情</h6><div class="row">';
                data.sessions.forEach((session, index) => {
                    detailsHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-primary me-2"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">${session.user_name}</div>
                                    <small class="text-muted">${session.item_name}</small>
                                    <span class="badge bg-info ms-2">${session.source_server}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                detailsHtml += '</div></div>';
                sessionDetails.innerHTML = detailsHtml;

            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = '无播放活动';
                speedMode.className = 'badge bg-success';
                speedMode.textContent = '默认限速';
                sessionDetails.innerHTML = '';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            document.getElementById('playback-status-text').textContent = '状态获取失败';
            document.getElementById('scheduler-status').className = 'badge bg-danger';
            document.getElementById('scheduler-status').textContent = '连接失败';
        });

    // 检查调度器状态
    fetch('/health')
        .then(response => response.json())
        .then(data => {
            const schedulerStatus = document.getElementById('scheduler-status');
            if (data.status === 'healthy') {
                schedulerStatus.className = 'badge bg-success';
                schedulerStatus.textContent = '运行中';
            } else {
                schedulerStatus.className = 'badge bg-danger';
                schedulerStatus.textContent = '异常';
            }
        })
        .catch(error => {
            const schedulerStatus = document.getElementById('scheduler-status');
            schedulerStatus.className = 'badge bg-danger';
            schedulerStatus.textContent = '连接失败';
        });
}, 10000);

// 下载器状态每3秒更新一次（需要更实时）
setInterval(updateDownloadersStatus, 3000);
</script>
{% endblock %} 