{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> {{ _('ç³»ç»ŸçŠ¶æ€') }}
                </h5>
            </div>
            <div class="card-body">
                <!-- æ’­æ”¾çŠ¶æ€æ¦‚è§ˆ -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <div id="playback-status-indicator" class="status-indicator status-inactive me-2"></div>
                            <div>
                                <h6 class="mb-0">{{ _('æ’­æ”¾çŠ¶æ€') }}</h6>
                                <span id="playback-status-text" class="text-muted">{{ _('åŠ è½½ä¸­...') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-server text-primary me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0">{{ _('åª’ä½“æœåŠ¡å™¨') }}</h6>
                                <span class="text-muted">{{ settings.media_servers | selectattr('enabled') | list | length }} {{ _('ä¸ªå·²å¯ç”¨') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-download text-success me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <h6 class="mb-0">{{ _('ä¸‹è½½å™¨') }}</h6>
                                <span class="text-muted">{{ settings.downloaders | selectattr('enabled') | list | length }} {{ _('ä¸ªå·²å¯ç”¨') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <!-- å®ä¾‹çŠ¶æ€ -->
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h6><i class="bi bi-server"></i> {{ _('åª’ä½“æœåŠ¡å™¨å®ä¾‹') }}</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_servers = settings.media_servers | selectattr('enabled') | list %}
                            {% if enabled_servers %}
                                {% for server in enabled_servers %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ server.id }}" data-instance-type="media_servers">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <img src="{{ url_for('static', filename='img/logos/' + server.type + '.png') }}" 
                                                     alt="{{ server.type }}" class="instance-logo"
                                                     onerror="this.style.display='none'">
                                                <span class="fw-bold">{{ server.name or _('æœªå‘½å') }}</span> 
                                                <span class="badge bg-secondary ms-2">{{ server.type | title }}</span>
                                            </div>
                                            <small class="text-muted d-block">{{ server.url or _('URLæœªé…ç½®') }}</small>
                                            <small class="text-info">{{ _('è½®è¯¢é—´éš”') }}: {{ server.poll_interval or 15 }}{{ _('ç§’') }}</small>
                                            <div class="mt-1" id="media-server-{{ server.id }}-status">
                                                <small class="text-muted">{{ _('åŠ è½½çŠ¶æ€ä¸­...') }}</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">
                                            <i class="bi bi-wifi"></i> {{ _('æµ‹è¯•') }}
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-server text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-1">{{ _('æ²¡æœ‰å·²å¯ç”¨çš„åª’ä½“æœåŠ¡å™¨') }}</p>
                                    <a href="{{ url_for('main.config') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-gear"></i> {{ _('å‰å¾€é…ç½®') }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-download"></i> {{ _('ä¸‹è½½å™¨å®ä¾‹') }}</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_downloaders = settings.downloaders | selectattr('enabled') | list %}
                            {% if enabled_downloaders %}
                                {% for downloader in enabled_downloaders %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ downloader.id }}" data-instance-type="downloaders">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <img src="{{ url_for('static', filename='img/logos/' + downloader.type + '.png') }}" 
                                                     alt="{{ downloader.type }}" class="instance-logo"
                                                     onerror="this.style.display='none'">
                                                <span class="fw-bold">{{ downloader.name or _('æœªå‘½å') }}</span> 
                                                <span class="badge bg-secondary ms-2">{{ downloader.type | title }}</span>
                                            </div>
                                            <small class="text-muted d-block">{{ downloader.url or _('URLæœªé…ç½®') }}</small>
                                            <div class="mt-1" id="downloader-{{ downloader.id }}-status">
                                                <small class="text-muted">{{ _('åŠ è½½çŠ¶æ€ä¸­...') }}</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">
                                            <i class="bi bi-wifi"></i> {{ _('æµ‹è¯•') }}
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <i class="bi bi-download text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-1">{{ _('æ²¡æœ‰å·²å¯ç”¨çš„ä¸‹è½½å™¨') }}</p>
                                    <a href="{{ url_for('main.config') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-gear"></i> {{ _('å‰å¾€é…ç½®') }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-clock-history text-info" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">{{ _('è°ƒåº¦å™¨çŠ¶æ€') }}</small>
                                <span id="scheduler-status" class="badge bg-success">{{ _('è¿è¡Œä¸­') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-speedometer2 text-warning" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">{{ _('å½“å‰é™é€Ÿæ¨¡å¼') }}</small>
                                <span id="speed-mode" class="badge bg-secondary">{{ _('æ£€æµ‹ä¸­') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-speedometer text-info" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">{{ _('å…¨å±€é€Ÿåº¦') }}</small>
                                <div id="global-speed" class="small">
                                    <div class="text-success"><i class="bi bi-download"></i> 0 KB/s</div>
                                    <div class="text-warning"><i class="bi bi-upload"></i> 0 KB/s</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="bi bi-journal-text text-secondary" style="font-size: 1.5rem;"></i>
                            <div class="mt-1">
                                <small class="text-muted d-block">{{ _('å¿«é€Ÿæ“ä½œ') }}</small>
                                <a href="{{ url_for('main.logs_page') }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-journal-text"></i> {{ _('æŸ¥çœ‹æ—¥å¿—') }}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="application/json" id="app-config">{{ settings | tojson | safe }}</script>
<script type="application/json" id="translations">{{ {
    'has': _('æœ‰'),
    'activePlaying': _('ä¸ªæ´»è·ƒæ’­æ”¾'),
    'playingSpeedLimit': _('æ’­æ”¾æ—¶é™é€Ÿ'),
    'noPlayingActivity': _('æ— æ’­æ”¾æ´»åŠ¨'),
    'defaultSpeedLimit': _('é»˜è®¤é™é€Ÿ'),
    'statusFetchFailed': _('çŠ¶æ€è·å–å¤±è´¥'),
    'connectionFailed': _('è¿æ¥å¤±è´¥'),
    'running': _('è¿è¡Œä¸­'),
    'abnormal': _('å¼‚å¸¸'),
    'actualSpeed': _('å®é™…é€Ÿåº¦'),
    'fetching': _('è·å–ä¸­...'),
    'activePlaying2': _('æ´»è·ƒæ’­æ”¾'),
    'sessions': _('ä¸ªä¼šè¯'),
    'note': _('æ³¨ï¼šæ˜¾ç¤ºåª’ä½“æ–‡ä»¶æ¯”ç‰¹ç‡ï¼Œéå®æ—¶ç½‘ç»œé€Ÿåº¦'),
    'instanceNotFound': _('æ— æ³•åœ¨é…ç½®ä¸­æ‰¾åˆ°è¯¥å®ä¾‹'),
    'configError': _('é…ç½®é”™è¯¯'),
    'connectionSuccess': _('è¿æ¥æˆåŠŸ'),
    'connectionTest': _('è¿æ¥æµ‹è¯•'),
    'connectionFailed2': _('è¿æ¥å¤±è´¥'),
    'networkError': _('ç½‘ç»œé”™è¯¯'),
    'test': _('æµ‹è¯•'),
    'networkErrorDuringTest': _('è¿æ¥æµ‹è¯•æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯'),
    'actualNetworkSpeed': _('ğŸ“Š å®é™…ç½‘ç»œä¼ è¾“é€Ÿåº¦'),
    'reflectsBandwidth': _('âœ“ åæ˜ çœŸå®å¸¦å®½ä½¿ç”¨'),
    'includedInGlobalStats': _('âœ“ å·²è®¡å…¥å…¨å±€é€Ÿåº¦ç»Ÿè®¡'),
    'mediaFileBitrate': _('ğŸ“„ åª’ä½“æ–‡ä»¶ç¼–ç æ¯”ç‰¹ç‡'),
    'referenceOnly': _('âš ï¸ ä»…ä½œå‚è€ƒï¼Œä¸åæ˜ å®é™…ç½‘ç»œä½¿ç”¨'),
    'bitrateNotAvailable': _('âš ï¸ æœªè·å–åˆ°æ¯”ç‰¹ç‡ä¿¡æ¯'),
    'notRealNetworkSpeed': _('âš ï¸ ä¸åæ˜ å®é™…ç½‘ç»œä¼ è¾“é€Ÿåº¦'),
    'suggestUsePlex': _('ğŸ’¡ å»ºè®®ä½¿ç”¨Plexè·å–çœŸå®æ•°æ®')
} | tojson | safe }}</script>
<script>
// ç¿»è¯‘å­—ç¬¦ä¸²
const translations = JSON.parse(document.getElementById('translations').textContent);

// å…¨å±€é…ç½®æ•°æ®
window.APP_CONFIG = JSON.parse(document.getElementById('app-config').textContent);

// é€šç”¨é”™è¯¯å¤„ç†å‡½æ•°
function handleApiError(error, response = null) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯401æœªæˆæƒé”™è¯¯
    if (response && response.status === 401) {
        window.location.href = '/login';
        return true; // è¡¨ç¤ºå·²å¤„ç†
    }
    
    // æ£€æŸ¥é”™è¯¯ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å«401
    if (error && (error.message.includes('401') || error.status === 401)) {
        window.location.href = '/login';
        return true; // è¡¨ç¤ºå·²å¤„ç†
    }
    
    return false; // æœªå¤„ç†ï¼Œéœ€è¦ç»§ç»­åŸæœ‰çš„é”™è¯¯å¤„ç†
}

function updateStatus() {
    // è·å–æ’­æ”¾çŠ¶æ€
    fetch('/api/media_server/sessions')
        .then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // å¦‚æœå·²ç»å¤„ç†äº†401é”™è¯¯
            
            const indicator = document.getElementById('playback-status-indicator');
            const statusText = document.getElementById('playback-status-text');
            const speedMode = document.getElementById('speed-mode');
            
            if (data.status === 'success' && data.sessions.length > 0) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = `${translations.has} ${data.count} ${translations.activePlaying}`;
                speedMode.className = 'badge bg-warning';
                speedMode.textContent = translations.playingSpeedLimit;
            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = translations.noPlayingActivity;
                speedMode.className = 'badge bg-success';
                speedMode.textContent = translations.defaultSpeedLimit;
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
            
            document.getElementById('playback-status-text').textContent = translations.statusFetchFailed;
            document.getElementById('scheduler-status').className = 'badge bg-danger';
            document.getElementById('scheduler-status').textContent = translations.connectionFailed;
        });

    // è·å–ä¸‹è½½å™¨çŠ¶æ€å’Œåª’ä½“æœåŠ¡å™¨é€Ÿåº¦
    updateDownloadersStatus();
    
    // æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
    fetch('/health')
        .then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // å¦‚æœå·²ç»å¤„ç†äº†401é”™è¯¯
            
            const schedulerStatus = document.getElementById('scheduler-status');
            if (data.status === 'healthy') {
                schedulerStatus.className = 'badge bg-success';
                schedulerStatus.textContent = translations.running;
            } else {
                schedulerStatus.className = 'badge bg-danger';
                schedulerStatus.textContent = translations.abnormal;
            }
        })
        .catch(error => {
            if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
            
            const schedulerStatus = document.getElementById('scheduler-status');
            schedulerStatus.className = 'badge bg-danger';
            schedulerStatus.textContent = translations.connectionFailed;
        });
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†å…ƒç´ ä¸­çš„æ‰€æœ‰tooltipå®ä¾‹
function cleanupTooltips(element) {
    const existingTooltips = element.querySelectorAll('[title]');
    existingTooltips.forEach(tooltipEl => {
        const tooltip = bootstrap.Tooltip.getInstance(tooltipEl);
        if (tooltip) {
            tooltip.dispose();
        }
    });
}

function updateDownloadersStatus() {
    // åŒæ—¶è·å–ä¸‹è½½å™¨çŠ¶æ€å’Œåª’ä½“æœåŠ¡å™¨é€Ÿåº¦
    Promise.all([
        fetch('/api/downloaders/status').then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return null;
            }
            return response.json();
        }),
        fetch('/api/media_server/speeds').then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return null;
            }
            return response.json();
        })
    ])
    .then(([downloadersData, mediaServerData]) => {
        // æ£€æŸ¥æ˜¯å¦æœ‰è®¤è¯é”™è¯¯ï¼ˆæ•°æ®ä¸ºnullï¼‰
        if (!downloadersData || !mediaServerData) {
            return; // å·²ç»é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        }
        
        if (downloadersData.status === 'success') {
            // è®¡ç®—å…¨å±€é€Ÿåº¦ï¼ˆä¸‹è½½å™¨çš„çœŸå®ç½‘ç»œé€Ÿåº¦ + Plexçš„çœŸå®ä¼ è¾“é€Ÿåº¦ï¼‰
            let totalDownloadSpeed = 0;
            let totalUploadSpeed = 0;
            
            // æ·»åŠ Plexçš„çœŸå®ä¼ è¾“é€Ÿåº¦åˆ°ä¸Šä¼ é€Ÿåº¦
            if (mediaServerData.status === 'success') {
                mediaServerData.sessions.forEach(session => {
                    // åªæœ‰Plexçš„çœŸå®å¸¦å®½æ•°æ®æ‰åŠ å…¥å…¨å±€é€Ÿåº¦ç»Ÿè®¡
                    if (session.source_server_type === 'plex' && session.transfer_type === 'real_bandwidth') {
                        // Plexçš„çœŸå®ç½‘ç»œä¼ è¾“é€Ÿåº¦ï¼ˆKB/sï¼‰ç›´æ¥åŠ å…¥ä¸Šä¼ é€Ÿåº¦ç»Ÿè®¡
                        totalUploadSpeed += (session.bitrate || 0); // å·²ç»æ˜¯KB/s
                    }
                });
            }
                
                // æ›´æ–°ä¸‹è½½å™¨çŠ¶æ€
                downloadersData.downloaders.forEach(downloader => {
                    // ç´¯åŠ å…¨å±€é€Ÿåº¦
                    if (downloader.current_speeds) {
                        totalDownloadSpeed += downloader.current_speeds.download_speed || 0;
                        totalUploadSpeed += downloader.current_speeds.upload_speed || 0;
                    }
                    
                    const statusElement = document.getElementById(`downloader-${downloader.id}-status`);
                    if (statusElement) {
                        let statusHtml = '';
                        
                        // æ˜¾ç¤ºå½“å‰æ¿€æ´»çš„é™é€Ÿæ¨¡å¼
                        const modeColor = downloader.speed_mode === 'playing' ? 'text-warning' : 'text-success';
                        const modeText = downloader.speed_mode === 'playing' ? translations.playingSpeedLimit : translations.defaultSpeedLimit;
                        const activeLimits = downloader.active_limits;
                        
                        statusHtml += `<small class="${modeColor}">`;
                        statusHtml += `<i class="bi bi-speedometer2"></i> ${modeText}: `;
                        statusHtml += `<i class="bi bi-download"></i> ${formatSpeed(activeLimits.download)} / <i class="bi bi-upload"></i> ${formatSpeed(activeLimits.upload)}`;
                        statusHtml += `</small>`;
                        
                        // æ˜¾ç¤ºå®é™…é€Ÿåº¦ï¼ˆå¦‚æœæ”¯æŒï¼‰
                        if (downloader.current_speeds && (downloader.type === 'qbittorrent' || downloader.type === 'transmission' || downloader.type === 'clouddrive2')) {
                            const currentSpeeds = downloader.current_speeds;
                            statusHtml += '<br>';
                            statusHtml += `<small class="text-info">`;
                            statusHtml += `<i class="bi bi-activity"></i> ${translations.actualSpeed}: `;
                            statusHtml += `<i class="bi bi-download"></i> ${formatActualSpeed(currentSpeeds.download_speed)} / <i class="bi bi-upload"></i> ${formatActualSpeed(currentSpeeds.upload_speed)}`;
                            statusHtml += `</small>`;
                        } else if (downloader.type === 'qbittorrent' || downloader.type === 'transmission' || downloader.type === 'clouddrive2') {
                            // æ”¯æŒè·å–é€Ÿåº¦ä½†å½“å‰æ— æ³•è·å–
                            statusHtml += '<br>';
                            statusHtml += `<small class="text-muted">`;
                            statusHtml += `<i class="bi bi-activity"></i> ${translations.actualSpeed}: ${translations.fetching}`;
                            statusHtml += `</small>`;
                        }
                        
                        statusElement.innerHTML = statusHtml;
                    }
                });
                
                // æ›´æ–°åª’ä½“æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
                if (mediaServerData.status === 'success') {
                    // åˆ›å»ºä¸€ä¸ªæŒ‰æœåŠ¡å™¨åˆ†ç»„çš„é€Ÿåº¦æ˜ å°„
                    const serverSpeedMap = {};
                    mediaServerData.sessions.forEach(session => {
                        const serverName = session.source_server;
                        if (!serverSpeedMap[serverName]) {
                            serverSpeedMap[serverName] = {
                                total_bitrate: 0,
                                sessions: []
                            };
                        }
                        serverSpeedMap[serverName].total_bitrate += session.bitrate || 0;
                        serverSpeedMap[serverName].sessions.push(session);
                    });
                    
                    // æ›´æ–°æ¯ä¸ªåª’ä½“æœåŠ¡å™¨çš„çŠ¶æ€æ˜¾ç¤º
                    document.querySelectorAll('[id^="media-server-"][id$="-status"]').forEach(element => {
                        const serverId = element.id.replace('media-server-', '').replace('-status', '');
                        
                        // ä»å…¨å±€é…ç½®ä¸­æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å™¨åç§°
                        const serverConfig = window.APP_CONFIG.media_servers.find(server => server.id === serverId);
                        const serverName = serverConfig ? (serverConfig.name || serverConfig.id) : serverId;
                        
                        const speedInfo = serverSpeedMap[serverName];
                        
                        if (speedInfo && speedInfo.total_bitrate > 0) {
                            // åœ¨æ›´æ–°å†…å®¹å‰ï¼Œå…ˆé”€æ¯ç°æœ‰çš„tooltipä»¥é¿å…æ‚¬æµ®bug
                            cleanupTooltips(element);
                            
                            let statusHtml = `<small class="text-info">`;
                            statusHtml += `<i class="bi bi-person-video3"></i> ${translations.activePlaying2}: ${speedInfo.sessions.length} ${translations.sessions}`;
                            statusHtml += `</small>`;
                            
                            // æ·»åŠ æ’­æ”¾è¯¦æƒ…
                            if (speedInfo.sessions.length > 0) {
                                statusHtml += `<div class="mt-2">`;
                                speedInfo.sessions.forEach((session, index) => {
                                                                statusHtml += `<div class="d-flex align-items-center mb-1">`;
                            statusHtml += `<i class="bi bi-person-circle text-primary me-1" style="font-size: 0.8rem;"></i>`;
                            statusHtml += `<small class="text-dark">`;
                            statusHtml += `<strong>${session.user_name}</strong>: ${session.item_name}`;
                            if (session.bitrate > 0) {
                                // æ ¹æ®æœåŠ¡å™¨ç±»å‹ä½¿ç”¨ä¸åŒçš„æ ¼å¼åŒ–æ–¹å¼
                                if (session.transfer_type === 'real_bandwidth') {
                                    // Plexçš„çœŸå®ä¼ è¾“é€Ÿåº¦ï¼ˆKB/sï¼‰+ åª’ä½“æ¯”ç‰¹ç‡
                                    statusHtml += ` <span class="text-success fw-bold" title="${translations.actualNetworkSpeed}<br>${translations.reflectsBandwidth}<br>${translations.includedInGlobalStats}" style="border-bottom: 1px dotted currentColor; cursor: help;">(${formatActualSpeed(session.bitrate)}</span>`;
                                    // å§‹ç»ˆæ˜¾ç¤ºåª’ä½“æ¯”ç‰¹ç‡ä¿¡æ¯
                                    if (session.media_bitrate && session.media_bitrate > 0) {
                                        statusHtml += ` <span class="text-muted fst-italic" title="${translations.mediaFileBitrate}<br>${translations.referenceOnly}" style="border-bottom: 1px dotted currentColor; cursor: help;">/ ${formatBitrate(session.media_bitrate)}</span>`;
                                    } else {
                                        statusHtml += ` <span class="text-muted fst-italic" title="${translations.mediaFileBitrate}<br>${translations.bitrateNotAvailable}" style="border-bottom: 1px dotted currentColor; cursor: help;">/ N/A</span>`;
                                    }
                                    statusHtml += `<span class="text-success">)</span>`;
                                } else {
                                    // Emby/Jellyfinçš„åª’ä½“æ¯”ç‰¹ç‡ï¼ˆKbpsï¼‰
                                    statusHtml += ` <span class="text-warning fst-italic" title="${translations.mediaFileBitrate}<br>${translations.notRealNetworkSpeed}<br>${translations.suggestUsePlex}" style="border-bottom: 1px dotted currentColor; cursor: help;">(${formatBitrate(session.bitrate)})</span>`;
                                }
                            }
                            statusHtml += `</small></div>`;
                                });
                                statusHtml += `</div>`;
                            }
                            

                            element.innerHTML = statusHtml;
                            
                            // åˆå§‹åŒ–æ–°æ·»åŠ çš„tooltipï¼ˆæ”¯æŒHTMLå†…å®¹ï¼‰
                            const titleElements = element.querySelectorAll('[title]');
                            const titleTooltips = [...titleElements].map(titleEl => new bootstrap.Tooltip(titleEl, {
                                html: true
                            }));
                        } else {
                            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„tooltip
                            cleanupTooltips(element);
                            
                            element.innerHTML = `<small class="text-muted">${translations.noPlayingActivity}</small>`;
                        }
                    });
                } else {
                    // é”™è¯¯æ—¶é‡ç½®åª’ä½“æœåŠ¡å™¨çŠ¶æ€
                    document.querySelectorAll('[id^="media-server-"][id$="-status"]').forEach(element => {
                        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„tooltip
                        cleanupTooltips(element);
                        
                        element.innerHTML = `<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> ${translations.statusFetchFailed}</small>`;
                    });
                }
                
                // æ›´æ–°å…¨å±€é€Ÿåº¦æ˜¾ç¤º
                const globalSpeedElement = document.getElementById('global-speed');
                if (globalSpeedElement) {
                    globalSpeedElement.innerHTML = `
                        <div class="text-success"><i class="bi bi-download"></i> ${formatActualSpeed(totalDownloadSpeed)}</div>
                        <div class="text-warning"><i class="bi bi-upload"></i> ${formatActualSpeed(totalUploadSpeed)}</div>
                    `;
                }
        }
    })
    .catch(error => {
        console.error('Error fetching status:', error);
        if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
        
        // åœ¨é”™è¯¯æƒ…å†µä¸‹æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
        document.querySelectorAll('[id^="downloader-"][id$="-status"]').forEach(element => {
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„tooltip
            cleanupTooltips(element);
            
            element.innerHTML = `<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> ${translations.statusFetchFailed}</small>`;
        });
        
        // é”™è¯¯æ—¶é‡ç½®åª’ä½“æœåŠ¡å™¨çŠ¶æ€
        document.querySelectorAll('[id^="media-server-"][id$="-status"]').forEach(element => {
            // æ¸…ç†å¯èƒ½å­˜åœ¨çš„tooltip
            cleanupTooltips(element);
            
            element.innerHTML = `<small class="text-muted"><i class="bi bi-exclamation-triangle"></i> ${translations.statusFetchFailed}</small>`;
        });
        
        // é”™è¯¯æ—¶é‡ç½®å…¨å±€é€Ÿåº¦æ˜¾ç¤º
        const globalSpeedElement = document.getElementById('global-speed');
        if (globalSpeedElement) {
            globalSpeedElement.innerHTML = `
                <div class="text-success"><i class="bi bi-download"></i> 0 KB/s</div>
                <div class="text-warning"><i class="bi bi-upload"></i> 0 KB/s</div>
            `;
        }
    });
}

function testInstance(button) {
    const btn = button;
    const itemElement = btn.closest('.list-group-item');
    const instanceId = itemElement.dataset.instanceId;
    const instanceType = itemElement.dataset.instanceType;
    
    // ä»å…¨å±€é…ç½®ä¸­æŸ¥æ‰¾å®ä¾‹çš„å…·ä½“ä¿¡æ¯
    const instanceConfig = window.APP_CONFIG[instanceType].find(inst => inst.id === instanceId);

    if (!instanceConfig) {
        showToast(translations.instanceNotFound, 'error', translations.configError);
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch('/test_connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            instance_config: instanceConfig,
            instance_type: instanceType
        })
    })
    .then(response => {
        if (!response.ok && response.status === 401) {
            handleApiError(null, response);
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return; // å¦‚æœå·²ç»å¤„ç†äº†401é”™è¯¯
        
        if (data.status === 'success') {
            showToast(`${instanceConfig.name || instanceConfig.type} ${translations.connectionSuccess}`, 'success', translations.connectionTest);
        } else {
            showToast(`${instanceConfig.name || instanceConfig.type} ${translations.connectionFailed2}: ${data.message}`, 'error', translations.connectionTest);
        }
    })
    .catch(error => {
        if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
        showToast(`${instanceConfig.name || instanceConfig.type} ${translations.networkErrorDuringTest}: ${error.message}`, 'error', translations.networkError);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-wifi"></i> ${translations.test}`;
    });
}

// é¡µé¢åŠ è½½æ—¶ç«‹å³æ›´æ–°çŠ¶æ€
updateStatus();

// æ’­æ”¾çŠ¶æ€æ¯10ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆä¸éœ€è¦å¤ªé¢‘ç¹ï¼‰
setInterval(() => {
    // è·å–æ’­æ”¾çŠ¶æ€
    fetch('/api/media_server/sessions')
        .then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // å¦‚æœå·²ç»å¤„ç†äº†401é”™è¯¯
            
            const indicator = document.getElementById('playback-status-indicator');
            const statusText = document.getElementById('playback-status-text');
            const speedMode = document.getElementById('speed-mode');
            
            if (data.status === 'success' && data.sessions.length > 0) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = `${translations.has} ${data.count} ${translations.activePlaying}`;
                speedMode.className = 'badge bg-warning';
                speedMode.textContent = translations.playingSpeedLimit;
            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = translations.noPlayingActivity;
                speedMode.className = 'badge bg-success';
                speedMode.textContent = translations.defaultSpeedLimit;
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
            
            document.getElementById('playback-status-text').textContent = translations.statusFetchFailed;
            document.getElementById('scheduler-status').className = 'badge bg-danger';
            document.getElementById('scheduler-status').textContent = translations.connectionFailed;
        });

    // æ£€æŸ¥è°ƒåº¦å™¨çŠ¶æ€
    fetch('/health')
        .then(response => {
            if (!response.ok && response.status === 401) {
                handleApiError(null, response);
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // å¦‚æœå·²ç»å¤„ç†äº†401é”™è¯¯
            
            const schedulerStatus = document.getElementById('scheduler-status');
            if (data.status === 'healthy') {
                schedulerStatus.className = 'badge bg-success';
                schedulerStatus.textContent = translations.running;
            } else {
                schedulerStatus.className = 'badge bg-danger';
                schedulerStatus.textContent = translations.abnormal;
            }
        })
        .catch(error => {
            if (handleApiError(error)) return; // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œå·²å¤„ç†
            
            const schedulerStatus = document.getElementById('scheduler-status');
            schedulerStatus.className = 'badge bg-danger';
            schedulerStatus.textContent = translations.connectionFailed;
        });
}, 10000);

// æ ¼å¼åŒ–æ¯”ç‰¹ç‡ï¼ˆè¾“å…¥å•ä½ï¼šKbpsï¼‰
function formatBitrate(kbps) {
    if (!kbps || kbps === 0) return '0 Kbps';
    
    if (kbps >= 1000000) {
        return (kbps / 1000000).toFixed(1) + ' Gbps';
    } else if (kbps >= 1000) {
        return (kbps / 1000).toFixed(1) + ' Mbps';
    } else {
        return kbps.toFixed(0) + ' Kbps';
    }
}

// ä¸‹è½½å™¨çŠ¶æ€æ¯3ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆéœ€è¦æ›´å®æ—¶ï¼‰
setInterval(updateDownloadersStatus, 3000);
</script>
{% endblock %} 