{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> 系统状态
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h6><i class="bi bi-server"></i> 媒体服务器</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_servers = settings.media_servers | selectattr('enabled') | list %}
                            {% if enabled_servers %}
                                {% for server in enabled_servers %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ server.id }}" data-instance-type="media_servers">
                                        <div>
                                            <span class="fw-bold">{{ server.name or '未命名' }}</span> <span class="badge bg-secondary">{{ server.type }}</span><br>
                                            <small class="text-muted">{{ server.url or 'URL未配置' }}</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">测试</button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small mt-2">没有已启用的媒体服务器。<a href="{{ url_for('main.config') }}">前往配置</a></p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-download"></i> 下载器</h6>
                        <div class="list-group list-group-flush">
                            {% set enabled_downloaders = settings.downloaders | selectattr('enabled') | list %}
                            {% if enabled_downloaders %}
                                {% for downloader in enabled_downloaders %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0" data-instance-id="{{ downloader.id }}" data-instance-type="downloaders">
                                        <div>
                                            <span class="fw-bold">{{ downloader.name or '未命名' }}</span> <span class="badge bg-secondary">{{ downloader.type }}</span><br>
                                            <small class="text-muted">{{ downloader.url or 'URL未配置' }}</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary test-btn" onclick="testInstance(this)">测试</button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small mt-2">没有已启用的下载器。<a href="{{ url_for('main.config') }}">前往配置</a></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <h6>当前播放状态</h6>
                <div class="d-flex align-items-center">
                    <div id="playback-status-indicator" class="status-indicator status-inactive"></div>
                    <span id="playback-status-text">加载中...</span>
                </div>
                <div id="session-details" class="mt-2 small"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i> 速率设置
                </h5>
            </div>
            <div class="card-body">
                {% set enabled_downloaders = settings.downloaders | selectattr('enabled') | list %}
                {% if enabled_downloaders %}
                <div class="small">
                    <strong>各下载器限速设置：</strong>
                    {% for downloader in enabled_downloaders %}
                    <div class="mb-2 p-2 bg-light rounded">
                        <div class="fw-bold">{{ downloader.name or '未命名' }}</div>
                        <div>默认：<span class="speed-display" data-download="{{ downloader.default_download_limit or 0 }}" data-upload="{{ downloader.default_upload_limit or 0 }}"></span></div>
                        <div>播放时：<span class="speed-display" data-download="{{ downloader.backup_download_limit or 1024 }}" data-upload="{{ downloader.backup_upload_limit or 512 }}"></span></div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">没有已启用的下载器</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> 轮询配置
                </h5>
            </div>
            <div class="card-body">
                {% set enabled_servers = settings.media_servers | selectattr('enabled') | list %}
                {% if enabled_servers %}
                <div class="small">
                    <strong>各服务器轮询间隔：</strong>
                    {% for server in enabled_servers %}
                    <div class="mb-1 p-1 bg-light rounded">
                        <span class="fw-bold">{{ server.name or '未命名' }}</span>：{{ server.poll_interval or 15 }}秒
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small">没有已启用的媒体服务器</p>
                {% endif %}
                <div class="alert alert-info small p-2 mt-2 mb-0">
                    <i class="bi bi-info-circle"></i> 每个服务器独立轮询，统一控制所有下载器
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="application/json" id="app-config">{{ settings | tojson | safe }}</script>
<script>
// 全局配置数据
window.APP_CONFIG = JSON.parse(document.getElementById('app-config').textContent);
function updateStatus() {
    fetch('/api/media_server/sessions')
        .then(response => response.json())
        .then(data => {
            const indicator = document.getElementById('playback-status-indicator');
            const statusText = document.getElementById('playback-status-text');
            const sessionDetails = document.getElementById('session-details');
            
            if (data.status === 'success' && data.sessions.length > 0) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = `有 ${data.count} 个活跃播放`;
                
                let detailsHtml = '<ul class="list-unstyled mb-0">';
                data.sessions.forEach(session => {
                    detailsHtml += `
                        <li class="mb-1">
                            <i class="bi bi-person"></i> ${session.user_name} 
                            <span class="text-muted">正在看</span> 
                            <i class="bi bi-play-circle"></i> ${session.item_name}
                            <span class="badge bg-info text-dark">${session.source_server}</span>
                        </li>
                    `;
                });
                detailsHtml += '</ul>';
                sessionDetails.innerHTML = detailsHtml;

            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = '无播放活动';
                sessionDetails.innerHTML = '';
            }
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            document.getElementById('playback-status-text').textContent = '状态获取失败';
        });
}

function testInstance(button) {
    const btn = button;
    const itemElement = btn.closest('.list-group-item');
    const instanceId = itemElement.dataset.instanceId;
    const instanceType = itemElement.dataset.instanceType;
    
    // 从全局配置中查找实例的具体信息
    const instanceConfig = window.APP_CONFIG[instanceType].find(inst => inst.id === instanceId);

    if (!instanceConfig) {
        showToast('无法在配置中找到该实例', 'error', '配置错误');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    
    fetch('/test_connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            instance_config: instanceConfig,
            instance_type: instanceType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`${instanceConfig.name || instanceConfig.type} 连接成功`, 'success', '连接测试');
        } else {
            showToast(`${instanceConfig.name || instanceConfig.type} 连接失败: ${data.message}`, 'error', '连接测试');
        }
    })
    .catch(error => {
        showToast(`${instanceConfig.name || instanceConfig.type} 连接测试时发生网络错误: ${error.message}`, 'error', '网络错误');
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = '测试';
    });
}

// 格式化速度显示
function formatSpeedDisplays() {
    document.querySelectorAll('.speed-display').forEach(element => {
        const downloadSpeed = element.getAttribute('data-download');
        const uploadSpeed = element.getAttribute('data-upload');
        
        const formattedDownload = formatSpeed(downloadSpeed);
        const formattedUpload = formatSpeed(uploadSpeed);
        
        element.textContent = `${formattedDownload} / ${formattedUpload}`;
    });
}

// 页面加载时和每10秒更新一次状态
updateStatus();
setInterval(updateStatus, 10000);

// 格式化速度显示
formatSpeedDisplays();
</script>
{% endblock %} 